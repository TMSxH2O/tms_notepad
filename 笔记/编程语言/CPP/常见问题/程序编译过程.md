
#编译 #优化

# 基础

## C++程序编译分为哪些阶段？各个阶段输出的文件是什么？

C++的程序编译可以分为四个阶段：

1. 预处理（编译指令是 `-E`）：处理宏的预处理指令，如 `include`、`define` 等（展开头文件、替换宏定义、删除注释等）。输入源代码，生成预处理后的文本文件（常见的后缀是 `.i`）
2. 编译（编译指令是 `-S`）：将预处理的结果，编译成汇编数据。这个阶段包括了语义检查，中间代码的生成和优化。生成汇编代码（常见的后缀是 `.s`）
3. 汇编（编译指令是 `-C`）：将汇编代码翻译成平台的机器码。生成对象文件（常见的后缀是 `.o` 或 `.obj`）
4. 链接（编译指令是 `-O`）：将多个目标文件（包括库），解析符号引用、分配得到最终的内存地址。生成可执行文件或动态库。

> 其中可能会扩展考察 `#include <xxx>` 和 `#include "xxx"` 的区别：
>  - `<xxx>` 表示从系统（编译器提供的）头文件路径下搜索
>  - `"xxx"` 表示优先从当前模块的包含路径下搜索，如果没找到，再到系统路径下搜索

# 进阶

## 编译阶段（Compilation）中，包含哪些核心步骤（如词法分析、语法分析等）？

 - **语法分析**：将源代码分割成 token（如关键字、标识符、操作符）
 - **语法分析**：根据语法规则生成抽象语法树（AST）
 - **语义分析**：检查类型匹配、作用域等语义错误（如函数参数类型不匹配）
 - ~~**中间代码生成**：将AST转换为中间表示（如三地址码、LLVM IR）~~ 太难记了，暂时忽略？
 - **代码优化**：对中间代码进行优化（如常量传播、函数内联、循环展开）
 - **目标代码生成**：将优化后的代码转换为汇编语言

## 在大型 C++ 项目中，如何优化编译速度？常用的编译优化手段有哪些？（可从预处理、编译、链接阶段分别说明）

预处理阶段：
- 使用 PCH 功能，将一些比较固定的头文件，提前编译成二进制文件，可以减少重复处理（GCC 可以使用 `-x c++-header`，Clang/MSVC 支持 `stdafx.h`）
- 避免不必要的 `include` 使用前向声明的方式来替代完整的头文件包含

编译阶段：
 - 并行编译，使用 `-jN` 选项利用多核并行编译模块内的多个源文件。
 - 增量编译，仅编译修改过的文件
 - 精简编译选项，关闭不必要的警告或调试选项（如非调试阶段关闭 `-g`）

链接阶段：
 - 优先使用动态链接替换静态链接

> **TODO** 黄金链接器（Gold Linker）和分块链接Link Time Optimize（LTO）？


